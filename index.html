<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Live Cam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b5cff">

<style>
body {
    margin: 0;
    background: #0f172a;
    color: #fff;
    font-family: Arial, sans-serif;
}
header {
    background: #0b5cff;
    padding: 12px;
    text-align: center;
    font-weight: bold;
}
#controls {
    padding: 10px;
    text-align: center;
}
button {
    padding: 10px 16px;
    border: none;
    background: #0b5cff;
    color: #fff;
    font-size: 15px;
    border-radius: 6px;
    cursor: pointer;
}
button:disabled {
    background: #555;
    cursor: not-allowed;
}
#link {
    margin-top: 10px;
    word-break: break-all;
    font-size: 14px;
    color: #22c55e;
}
#videos {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    justify-content: center;
}
video {
    width: 160px;
    background: black;
    border-radius: 8px;
}
.status {
    font-size: 13px;
    color: #94a3b8;
    margin-top: 5px;
}
</style>
</head>

<body>
<header>üì° Live Cam</header>

<div id="controls">
    <button id="btnLink" disabled>üîó Gerar Link</button>
    <button id="btnRecord">‚è∫Ô∏è Gravar</button>
    <button id="btnStop">‚èπÔ∏è Parar</button>
    <div class="status" id="status">Inicializando conex√£o...</div>
    <div id="link"></div>
</div>

<div id="videos"></div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
const videos = document.getElementById("videos");
const linkDiv = document.getElementById("link");
const btnLink = document.getElementById("btnLink");
const btnRecord = document.getElementById("btnRecord");
const btnStop = document.getElementById("btnStop");
const statusEl = document.getElementById("status");

let peerId = null;
let localStream = null;
let recorder = null;
let recordedChunks = [];

/* ‚úÖ PeerJS Cloud (corre√ß√£o principal) */
const peer = new Peer();

/* Quando conectar */
peer.on("open", id => {
    peerId = id;
    btnLink.disabled = false;
    statusEl.innerText = "Conectado. Pronto para gerar link.";

    const params = new URLSearchParams(location.search);
    const room = params.get("r");

    if (room) {
        startCamera().then(() => {
            peer.call(room, localStream);
        });
    }
});

/* Receber chamadas */
peer.on("call", call => {
    startCamera().then(() => {
        call.answer(localStream);
        call.on("stream", remoteStream => addVideo(remoteStream));
    });
});

/* Iniciar c√¢mera */
function startCamera() {
    if (localStream) return Promise.resolve();

    return navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            localStream = stream;
            addVideo(stream);
        })
        .catch(() => alert("Permiss√£o de c√¢mera/microfone negada"));
}

/* Adicionar v√≠deo */
function addVideo(stream) {
    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.playsInline = true;
    videos.appendChild(video);
}

/* Gerar link */
btnLink.onclick = () => {
    const url = `${location.origin}${location.pathname}?r=${peerId}`;
    linkDiv.innerText = url;
    navigator.clipboard.writeText(url);
};

/* Gravar */
btnRecord.onclick = () => {
    if (!localStream) return alert("Nenhum v√≠deo para gravar");

    recordedChunks = [];
    recorder = new MediaRecorder(localStream);
    recorder.ondataavailable = e => recordedChunks.push(e.data);
    recorder.start();
    statusEl.innerText = "üî¥ Gravando...";
};

/* Parar grava√ß√£o */
btnStop.onclick = () => {
    if (!recorder) return;
    recorder.stop();
    recorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "gravacao.webm";
        a.click();
        statusEl.innerText = "Grava√ß√£o salva";
    };
};
</script>

</body>
</html>
